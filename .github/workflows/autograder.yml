name: Autograder

on:
  push:
    branches: ["*"]

permissions:
  contents: read

jobs:
  grade:
    name: Grade Submission
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # â”€â”€ 1. Check out student repository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout student code
        uses: actions/checkout@v4

      # â”€â”€ 2. Set up Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # â”€â”€ 3. Install student dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€ 4. Fetch private grader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      #    The grader lives in a separate private repo so students
      #    cannot read the reference solutions.
      #
      #    SETUP REQUIRED (one-time, by the instructor / TA):
      #      1. Create a private repo, e.g.  <org>/hw1-grader
      #         and push grade.py into it.
      #      2. Create a Fine-Grained Personal Access Token (PAT)
      #         with read-only access to that repo.
      #      3. Add the PAT as an Organization Secret named
      #         GRADER_PAT  (Settings â†’ Secrets â†’ Actions).
      - name: Fetch grader
        run: |
          git clone https://x-access-token:${{ secrets.GRADER_PAT }}@github.com/${{ github.repository_owner }}/hw1-grader.git .grader
        env:
          GIT_TERMINAL_PROMPT: 0

      # â”€â”€ 5. Run grader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Run autograder
        id: grading
        continue-on-error: true
        run: |
          cd ${{ github.workspace }}
          PYTHONPATH=".grader:." python .grader/grade.py 2>&1 | tee grading_output.txt
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}

      # â”€â”€ 6. Post results to Job Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Post grading summary
        if: always()
        run: |
          echo "## ðŸ“ HW1 Autograder Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f grading_results.json ]; then
            TOTAL=$(python -c "import json; d=json.load(open('grading_results.json')); print(d['total'])")
            MAX=$(python -c "import json; d=json.load(open('grading_results.json')); print(d['max_total'])")
            LOOKBACK=$(python -c "import json; d=json.load(open('grading_results.json')); print(d['lookback_days'])")

            echo "**Look-back period:** ${LOOKBACK} trading days" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Test | Score |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-------|" >> $GITHUB_STEP_SUMMARY

            python -c "
          import json
          d = json.load(open('grading_results.json'))
          for t in d['tests']:
              icon = 'âœ…' if t['points'] == t['max_points'] else ('ðŸŸ¡' if t['points'] > 0 else 'âŒ')
              print(f\"| {icon} {t['name']} | {t['points']:.1f} / {t['max_points']:.1f} |\")
          " >> $GITHUB_STEP_SUMMARY

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ† Total: ${TOTAL} / ${MAX}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Grading failed.** Check the logs above for details." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat grading_output.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No output captured."  >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
